name: URL Validation - Batched

on:
  # Run every 2 hours
  schedule:
    - cron: '0 */2 * * *'
  
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      batch_size:
        description: 'Number of countries per batch'
        required: false
        default: '5'
        type: string
      rate_limit:
        description: 'Maximum requests per second'
        required: false
        default: '2.0'
        type: string
      create_issue:
        description: 'Create GitHub issue to track progress'
        required: false
        default: 'true'
        type: boolean

jobs:
  validate-urls-batch:
    runs-on: ubuntu-latest
    # Timeout matches BatchConfig.max_runtime_minutes in src/services/batch_coordinator.py
    # Set to 110 minutes to leave 10-minute buffer before GitHub's 2-hour limit
    timeout-minutes: 110
    permissions:
      contents: write
      issues: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
      
      - name: Download previous metadata DB (if exists)
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: validation-metadata
          path: data/
      
      - name: Run batch validation
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Set default values for scheduled runs
          BATCH_SIZE="${{ github.event.inputs.batch_size || '5' }}"
          RATE_LIMIT="${{ github.event.inputs.rate_limit || '2.0' }}"
          CREATE_ISSUE="${{ github.event.inputs.create_issue || 'true' }}"
          
          # Build command
          CMD="python3 -m src.cli.validate_urls_batch \
            --batch-mode \
            --batch-size $BATCH_SIZE \
            --rate-limit $RATE_LIMIT"
          
          # Add create-issue flag if enabled
          if [ "$CREATE_ISSUE" = "true" ]; then
            CMD="$CMD --create-issue"
          fi
          
          # Run validation
          $CMD 2>&1 | tee batch-validation-output.txt
      
      - name: Generate validation report
        if: always()
        run: |
          python3 -m src.cli.generate_validation_report \
            --output validation-report.md
      
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: validation-metadata
          path: |
            data/metadata.db
          retention-days: 90
          overwrite: true
      
      - name: Upload batch report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: batch-validation-report-${{ github.run_number }}
          path: |
            validation-report.md
            batch-validation-output.txt
          retention-days: 30
          if-no-files-found: warn
      
      - name: Display report summary
        if: always()
        run: |
          if [ -f validation-report.md ]; then
            echo "## Validation Report Summary" >> $GITHUB_STEP_SUMMARY
            cat validation-report.md >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Batch Processing Info" >> $GITHUB_STEP_SUMMARY
          echo "- Batch Size: ${{ github.event.inputs.batch_size || '5' }} countries" >> $GITHUB_STEP_SUMMARY
          echo "- Rate Limit: ${{ github.event.inputs.rate_limit || '2.0' }} req/sec" >> $GITHUB_STEP_SUMMARY
          echo "- Workflow Run: [\#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
